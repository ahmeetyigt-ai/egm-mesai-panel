<!doctype html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8" />
  <style>
    body{font-family:Arial;margin:20px;background:#0b1220;color:#e6eefc}
    .card{max-width:720px;margin:auto;background:#101b33;border:1px solid #22345f;border-radius:14px;padding:18px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:10px 0}
    input,select,button{padding:10px;border-radius:10px;border:1px solid #2a3f73;background:#0e1730;color:#e6eefc}
    button{cursor:pointer}
    .msg{margin-top:10px;padding:10px;border-radius:10px;background:#0e1730;border:1px solid #22345f}
    .ok{border-color:#2d6a4f}
    .err{border-color:#a4161a}
    .muted{opacity:.75}
    label{min-width:90px}
  </style>
</head>
<body>
  <div class="card">
    <h2>Mesai Başlat / Bitir</h2>
    <div class="muted">İsim yaz → Birim seç → Başlat. Bitir için aynı ismi seç/yaz.</div>

    <div class="row">
      <label>İsim:</label>
      <input id="personel" list="plist" placeholder="örn: ahmet" />
      <datalist id="plist"></datalist>
    </div>

    <div class="row">
      <label>Birim:</label>
      <select id="birim">
        <option value="">Birim Seç</option>
        <option>Asayiş</option>
        <option>İdari</option>
        <option>Destek</option>
      </select>
      <span class="muted">(İstersen listeden seç veya yazılan kayıtlar arttıkça otomatik çıkar.)</span>
    </div>

    <div class="row">
      <button onclick="start()">Mesai Başlat</button>
      <button onclick="end()">Mesai Bitir</button>
      <button onclick="reloadLists()">Liste Yenile</button>
    </div>

    <div id="msg" class="msg muted">Hazır.</div>
  </div>

<script>
  const msgEl = document.getElementById('msg');

  function setMsg(text, type){
    msgEl.textContent = text;
    msgEl.classList.remove('ok','err','muted');
    msgEl.classList.add(type || 'muted');
  }

  function getForm(){
    return {
      personel: document.getElementById('personel').value.trim(),
      birim: document.getElementById('birim').value.trim()
    };
  }

  function start(){
    const f = getForm();
    setMsg('Kaydediliyor...', 'muted');
    google.script.run
      .withSuccessHandler(res => {
        setMsg(res.msg || 'Mesai başladı.', 'ok');
        reloadLists();
      })
      .withFailureHandler(err => {
        console.error(err);
        setMsg('Hata: ' + (err?.message || err), 'err');
      })
      .startMesai(f);
  }

  function end(){
    const f = getForm();
    setMsg('Kapatılıyor...', 'muted');
    google.script.run
      .withSuccessHandler(res => {
        setMsg(res.msg || 'Mesai bitti.', 'ok');
        reloadLists();
      })
      .withFailureHandler(err => {
        console.error(err);
        setMsg('Hata: ' + (err?.message || err), 'err');
      })
      .endMesai({ personel: f.personel });
  }

  function reloadLists(){
    google.script.run
      .withSuccessHandler(data => {
        const dl = document.getElementById('plist');
        dl.innerHTML = '';
        (data.personeller || []).forEach(p => {
          const o = document.createElement('option');
          o.value = p;
          dl.appendChild(o);
        });

        // birimleri sheet'ten de ekleyelim (mevcut seçenekleri bozmadan)
        const birimSel = document.getElementById('birim');
        const existing = new Set([...birimSel.options].map(o => o.value).filter(Boolean));
        (data.birimler || []).forEach(b => {
          if (!existing.has(b)) {
            const opt = document.createElement('option');
            opt.value = b;
            opt.textContent = b;
            birimSel.appendChild(opt);
            existing.add(b);
          }
        });
      })
      .withFailureHandler(err => {
        console.error(err);
        setMsg('Liste yenileme hatası: ' + (err?.message || err), 'err');
      })
      .getLists();
  }

  reloadLists();
</script>
</body>
</html>
