<!doctype html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8" />
  <style>
    body{font-family:Arial;margin:20px;background:#0b1220;color:#e6eefc}
    .card{max-width:900px;margin:auto;background:#101b33;border:1px solid #22345f;border-radius:14px;padding:16px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    input,select,button{padding:10px;border-radius:10px;border:1px solid #2a3f73;background:#0e1730;color:#e6eefc}
    button{cursor:pointer}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{border-bottom:1px solid #22345f;padding:10px;text-align:left}
    .muted{opacity:.7}
  </style>
</head>
<body>
  <div class="card">
    <h2>Mesai Takip (Müdür)</h2>

    <div class="row">
      <label class="muted">Tarih:</label>
      <input id="tarih" type="date">

      <select id="birim">
        <option value="">Bütün Birimler</option>
      </select>

      <select id="personel">
        <option value="">Bütün Personeller</option>
      </select>

      <button onclick="today()">Bugün</button>
      <button onclick="search()">Ara</button>
      <button onclick="clearAll()">Temizle</button>
    </div>

    <div class="row" style="margin-top:10px">
      <button onclick="refreshLists()">Veri Yenile</button>
      <span id="msg" class="muted"></span>
    </div>

    <table>
      <thead>
        <tr>
          <th>Personel (Birim)</th>
          <th>Başlangıç</th>
          <th>Bitiş</th>
          <th>Tarih</th>
        </tr>
      </thead>
      <tbody id="tbody">
        <tr><td colspan="4" class="muted">Henüz veri yok.</td></tr>
      </tbody>
    </table>

    <div class="muted" id="count" style="margin-top:8px">Kayıt sayısı: 0</div>
  </div>

<script>
  function setMsg(t){ document.getElementById('msg').textContent = t || ''; }

  function today(){
    const d = new Date();
    const iso = d.toISOString().slice(0,10);
    document.getElementById('tarih').value = iso;
  }

  function clearAll(){
    document.getElementById('tarih').value = '';
    document.getElementById('birim').value = '';
    document.getElementById('personel').value = '';
    render([]);
  }

  function refreshLists(){
    setMsg('Listeler yükleniyor...');
    google.script.run
      .withSuccessHandler(data => {
        fillSelect('birim', data.birimler, 'Bütün Birimler');
        fillSelect('personel', data.personeller, 'Bütün Personeller');
        setMsg('Tamam');
        setTimeout(()=>setMsg(''), 1200);
      })
      .withFailureHandler(err => {
        console.error(err);
        setMsg('Hata: ' + (err?.message || err));
      })
      .getLists();
  }

  function fillSelect(id, items, allText){
    const sel = document.getElementById(id);
    sel.innerHTML = `<option value="">${allText}</option>`;
    (items||[]).forEach(x=>{
      const opt = document.createElement('option');
      opt.value = x;
      opt.textContent = x;
      sel.appendChild(opt);
    });
  }

  function search(){
    const filters = {
      tarih: document.getElementById('tarih').value,
      birim: document.getElementById('birim').value,
      personel: document.getElementById('personel').value
    };
    setMsg('Aranıyor...');
    google.script.run
      .withSuccessHandler(rows => {
        render(rows || []);
        setMsg('Tamam');
        setTimeout(()=>setMsg(''), 1200);
      })
      .withFailureHandler(err => {
        console.error(err);
        setMsg('Hata: ' + (err?.message || err));
      })
      .getMesaiList(filters);
  }

  function render(rows){
    const tb = document.getElementById('tbody');
    const count = document.getElementById('count');
    if (!rows || rows.length === 0){
      tb.innerHTML = `<tr><td colspan="4" class="muted">Henüz veri yok.</td></tr>`;
      count.textContent = 'Kayıt sayısı: 0';
      return;
    }
    tb.innerHTML = rows.map(r => `
      <tr>
        <td>${escapeHtml(r.personel)} <span class="muted">(${escapeHtml(r.birim)})</span></td>
        <td>${escapeHtml(r.baslangic)}</td>
        <td>${escapeHtml(r.bitis || '')}</td>
        <td>${escapeHtml(r.tarih)}</td>
      </tr>
    `).join('');
    count.textContent = 'Kayıt sayısı: ' + rows.length;
  }

  function escapeHtml(s){
    return String(s||'')
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'","&#039;");
  }

  // ilk yükleme
  today();
  refreshLists();
  search();
</script>
</body>
</html>
