<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Personel Mesai</title>
<style>
  body{font-family:system-ui,Segoe UI,Arial;margin:0;background:#0b1220;color:#eaf0ff}
  .wrap{max-width:900px;margin:0 auto;padding:24px 16px}
  .card{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);border-radius:14px;padding:16px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:12px 0}
  input,select{padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.16);background:rgba(0,0,0,.25);color:#eaf0ff;outline:none}
  button{padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.16);background:rgba(255,255,255,.08);color:#eaf0ff;cursor:pointer}
  button:hover{background:rgba(255,255,255,.12)}
  .ok{display:none;margin-top:10px;border:1px solid rgba(96,255,156,.22);background:rgba(96,255,156,.10);padding:10px 12px;border-radius:12px}
  .err{display:none;margin-top:10px;border:1px solid rgba(255,59,88,.35);background:rgba(255,59,88,.12);padding:10px 12px;border-radius:12px}
  .badge{padding:6px 10px;border:1px solid rgba(255,255,255,.16);border-radius:999px;background:rgba(255,255,255,.05)}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;">
      <div>
        <h2 style="margin:0">Mesai Başlat / Bitir</h2>
        <div style="opacity:.75">Birim seç → Başlat → Bitir</div>
      </div>
      <div class="badge" id="today"></div>
    </div>

    <div class="row">
      <input id="personel" placeholder="Personel adı" style="min-width:240px">
      <select id="birim" style="min-width:240px">
        <option value="">Birim seç</option>
      </select>
    </div>

    <div class="row">
      <button id="btnStart">Mesai Başlat</button>
      <button id="btnEnd">Mesai Bitir</button>
    </div>

    <div class="ok" id="ok"></div>
    <div class="err" id="err"></div>
  </div>
</div>

<script>
  const pEl = document.getElementById("personel");
  const uEl = document.getElementById("birim");
  const ok = document.getElementById("ok");
  const err = document.getElementById("err");
  const todayBadge = document.getElementById("today");

  function showOk(t){ ok.style.display="block"; ok.textContent=t; setTimeout(()=>ok.style.display="none",1500); }
  function showErr(t){ err.style.display="block"; err.textContent=t; }
  function hideErr(){ err.style.display="none"; err.textContent=""; }

  function todayTR(){
    const now = new Date();
    const tr = new Date(now.toLocaleString("en-US",{timeZone:"Europe/Istanbul"}));
    return tr.toISOString().slice(0,10);
  }
  function timeTR(){
    const now = new Date();
    const tr = new Date(now.toLocaleString("en-US",{timeZone:"Europe/Istanbul"}));
    const h = String(tr.getHours()).padStart(2,"0");
    const m = String(tr.getMinutes()).padStart(2,"0");
    const s = String(tr.getSeconds()).padStart(2,"0");
    return `${h}:${m}:${s}`;
  }

  todayBadge.textContent = "Tarih: " + todayTR();

  // ✅ Birimleri Sheet’ten çek: daha önce kullanılan birimler
  function loadUnits(){
    google.script.run
      .withSuccessHandler(units=>{
        const cur = uEl.value || "";
        uEl.innerHTML = `<option value="">Birim seç</option>` +
          (Array.isArray(units)?units:[]).map(u=>`<option>${u}</option>`).join("") +
          `<option>Asayiş</option><option>Trafik</option><option>Personel</option><option>İstihbarat</option><option>Narkotik</option>`;
        uEl.value = cur;
      })
      .listUnits();
  }
  loadUnits();

  document.getElementById("btnStart").addEventListener("click", ()=>{
    hideErr();
    const personel = pEl.value.trim();
    const birim = uEl.value.trim();
    if(!personel) return showErr("Personel adı yaz.");
    if(!birim) return showErr("Birim seçmeden başlayamazsın.");

    google.script.run
      .withSuccessHandler(res=>{
        res = String(res).trim();
        if(res==="ok") showOk("Başlatıldı ✅");
        else if(res==="missing_birim") showErr("Birim seç.");
        else showErr("Hata: " + res);
      })
      .withFailureHandler(e=>showErr("Hata: "+(e.message||e)))
      .logStart_(personel, birim, timeTR(), todayTR());
  });

  document.getElementById("btnEnd").addEventListener("click", ()=>{
    hideErr();
    const personel = pEl.value.trim();
    if(!personel) return showErr("Personel adı yaz.");

    google.script.run
      .withSuccessHandler(res=>{
        res = String(res).trim();
        if(res==="ok") showOk("Bitti ✅");
        else if(res==="no_row_found") showErr("Açık mesai bulunamadı.");
        else showErr("Hata: " + res);
      })
      .withFailureHandler(e=>showErr("Hata: "+(e.message||e)))
      .logEnd_(personel, timeTR(), todayTR());
  });
</script>
</body>
</html>
